CREATE TABLE PROJ_CLIENTE(
	CLIENTEID NUMERIC(18,0) PRIMARY KEY,
	NOME VARCHAR(250) NOT NULL,
	CPF VARCHAR(20) NOT NULL,
	SEXO VARCHAR(2) CHECK (SEXO in ('M','F')),
	DATA_NASCIMENTO DATETIME NOT NULL,
	ENDERECO VARCHAR(250) NOT NULL,
	NUMERO_END NUMERIC(18,0) NOT NULL,
	BAIRRO VARCHAR(250),
	CIDADE VARCHAR(50) NOT NULL,
	ESTADO VARCHAR(2) NOT NULL,
	PAIS VARCHAR(20),
	INF_PAGAMENTO NUMERIC(18,0) NOT NULL,
	DATA_CADASTRO DATETIME NOT NULL
)

CREATE TABLE PROJ_PAGAMENTO(
	PAGAMENTOID NUMERIC(18,0) PRIMARY KEY,
	NOME VARCHAR(50) NOT NULL,
	FORMA_PAGTO VARCHAR(30) CHECK (FORMA_PAGTO in ('D','C','P','B')) NOT NULL,
	JUROS_DIA NUMERIC(18,2),
	DESCONTO_AD NUMERIC(18,2) 
)

CREATE TABLE PROJ_REVISTA(
	REVISTAID NUMERIC(18,0) PRIMARY KEY,
	NUM_EDICAO NUMERIC(18,0) NOT NULL,
	NOME VARCHAR(250) NOT NULL,
	EDITORA VARCHAR(100) NOT NULL,
	DATA_LANCAMENTO DATETIME NOT NULL,
	PRECO NUMERIC(18,2) NOT NULL,
	PERIODICIDADE VARCHAR(20) CHECK(PERIODICIDADE IN ('SEMANAL','QUINZENAL','MENSAL','SEMESTRAL','ANUAL')) NOT NULL,
	FAIXA_ETARIA NUMERIC(18,0) NOT NULL
)

CREATE TABLE PROJ_ASSINATURA(
	ASSINATURAID NUMERIC(18,0) NOT NULL,
	CLIENTEID NUMERIC(18,0) NOT NULL,
	REVISTAID NUMERIC(18,0) NOT NULL,
	DATA_VIGENCIA DATETIME NOT NULL,
	ENDERECO_COBRANCA VARCHAR(250) NOT NULL,
	NUMERO_END NUMERIC(18,0) NOT NULL,
	DATA_VENCIMENTO DATETIME NOT NULL,
	FORMA_PAGAMENTOID NUMERIC(18,0) NOT NULL,
	SIT_PAGAMENTO VARCHAR(2) CHECK(SIT_PAGAMENTO IN('S','N')) NOT NULL

	PRIMARY KEY(ASSINATURAID,CLIENTEID, REVISTAID),
	FOREIGN KEY (CLIENTEID) REFERENCES PROJ_CLIENTE (CLIENTEID),
	FOREIGN KEY (REVISTAID) REFERENCES PROJ_REVISTA (REVISTAID),
	FOREIGN KEY (FORMA_PAGAMENTOID) REFERENCES PROJ_PAGAMENTO (PAGAMENTOID)
)

/*----------------------INSERTS-------------*/

INSERT INTO PROJ_CLIENTE VALUES (1,'JOAO SILVA','777.987.401-78','M',GETDATE()-9200,'RUA DAS FLORES',245,'MONTE CARLOS','SAO BERNANDO DO CAMPO','SP','BRASIL',456789,GETDATE()-360)
INSERT INTO PROJ_CLIENTE VALUES (2,'MARINA SOUZA','803.345.970-70','F',GETDATE()-10200,'AVENIDA CONSOLACAO',1045,'ULTIMOS SUSPIRROS','CAPUIARI','TO','BRASIL',123456,GETDATE()-60)
INSERT INTO PROJ_CLIENTE VALUES (3,'LUISA MEDEIROS','321.012.130-69','F',GETDATE()-6400,'AVENIDA COPACABANA',13,'BOA VISTA','RIO DE JANEIRO','RJ','BRASIL',751369,GETDATE()-120)

INSERT INTO PROJ_PAGAMENTO VALUES (1,'A VISTA','D',0.0,0.0)
INSERT INTO PROJ_PAGAMENTO VALUES (2,'PRAZO','C',0.0,0.0)
INSERT INTO PROJ_PAGAMENTO VALUES (3,'BOLETO BANCARIO','B',0.0,0.0)

INSERT INTO PROJ_REVISTA VALUES(1,220,'PEQUENAS EMPRESAS GRANDES NEGOCIOS','GLOBO',GETDATE()-30,20.00,'MENSAL',0)
INSERT INTO PROJ_REVISTA VALUES(2,1001,'COSMOS','ARTE LUZ',GETDATE()-15,45.50,'MENSAL',0)
INSERT INTO PROJ_REVISTA VALUES(3,3,'VAI FUNDO','PLAYBOY',GETDATE()-3,15.90,'MENSAL',18)

INSERT INTO PROJ_ASSINATURA VALUES (1,1,3,GETDATE()-20,'RUA DAS FLORES',245,GETDATE()+15,2,'N')
INSERT INTO PROJ_ASSINATURA VALUES (2,2,2,GETDATE()-15,'AVENIDA CONSOLACAO',1045,GETDATE()+15,1,'S')
INSERT INTO PROJ_ASSINATURA VALUES (3,3,1,GETDATE()-3,'AVENIDA COPACABANA',13,GETDATE()+15,3,'S')

/*----------------------EXERCICIOS-------------*/

/*EXERCICIO 1: OBJETIVO: TRAZER O PRIMEIRO CLIENTE CADASTRADO COM O SEXO FEMININO*/
SELECT ASSINATURAID, CLIENTEID, REVISTAID, ENDERECO_COBRANCA, NUMERO_END 
FROM  PROJ_ASSINATURA
WHERE CLIENTEID = (SELECT TOP 1 CLIENTEID FROM PROJ_CLIENTE WHERE SEXO = 'F')

/*EXERCICIO 2: OBJETIVO: RETORNAR TODAS AS REVISTAS QUE POSSUEM ASSINATURAS E QUE AS 
	FORMAS DE PAGAMENTOS QUE ESTAS ASSINATURAM TEM ESTEJAM COM DESCONTO MENOR QUE 5%*/
SELECT A.ASSINATURAID, R.REVISTAID, R.NUM_EDICAO, R.NOME, R.PRECO 
	FROM  PROJ_ASSINATURA A INNER JOIN PROJ_REVISTA R 
		ON A.REVISTAID = R.REVISTAID
		WHERE A.FORMA_PAGAMENTOID IN (SELECT PAGAMENTOID FROM PROJ_PAGAMENTO 
										WHERE DESCONTO_AD < 3)

/*EXERCICIO 3: OBJETIVO: RETORNAR TODAS AS REVISTAS QUE POSSUEM ASSINATURAS E QUE
 OS CLIENTES DESSAS ASSINATURAS NÃO SEJAM MULHERES*/
SELECT A.ASSINATURAID, A.CLIENTEID, R.REVISTAID, R.NUM_EDICAO, R.NOME, 
	R.EDITORA,R.DATA_LANCAMENTO, R.PERIODICIDADE, R.FAIXA_ETARIA
	FROM  PROJ_ASSINATURA A INNER JOIN PROJ_REVISTA R 
		ON A.REVISTAID = R.REVISTAID
		WHERE A.CLIENTEID NOT IN (SELECT CLIENTEID FROM PROJ_CLIENTE
										WHERE SEXO = 'F')

/*EXERCICIO 4: OBJETIVO: RETORNA TODAS AS ASSINATURAS SE HOUVER ALGUM 
	CLIENTE MENOR DE 18 ANOS*/
 SELECT * FROM PROJ_ASSINATURA  
	WHERE EXISTS (SELECT * FROM PROJ_CLIENTE 
					WHERE YEAR(DATA_NASCIMENTO) > YEAR(GETDATE())-18)

/*EXERCICIO 5: OBJETIVO: RETORNA TODAS AS REVISTAS SE 'NÃO' HOUVER ASSINATURA
		COM SITUAÇÃO DE PAGAMENTO 'N' (NÃO ESTIVER PAGO*/
SELECT * FROM PROJ_REVISTA
WHERE NOT EXISTS (SELECT * FROM PROJ_ASSINATURA WHERE SIT_PAGAMENTO = 'N')

/*EXECICIO 6: OBJETIVO: ATUALIZAR O VALOR DA REVISTA PARA 90% DO PRECO ATUAL
PARA TODAS AS REVISTAS. SE E SOMENTE SE NA TABELA DE ASSINATUA HOUVER MAIS DE 10 REGISTROS
QUE TENHAM A FORMA DE PAGAMENTO NO BOLETO E ESTEJAM COM A SITUAÇÃO 'N' (NÃO PAGO)*/
UPDATE PROJ_REVISTA SET PRECO = PRECO*0.9
WHERE REVISTAID IN (SELECT REVISTAID 
						FROM PROJ_ASSINATURA A INNER JOIN PROJ_PAGAMENTO P
						ON A.FORMA_PAGAMENTOID = P.PAGAMENTOID
						WHERE P.FORMA_PAGTO = 'B'
						AND A.SIT_PAGAMENTO = 'N'
						GROUP BY REVISTAID HAVING (COUNT(REVISTAID))>10)

/*EXECICIO 7: OBJETIVO: DELETAR OS REGISTROS DA TABELA ASSINATURA
SE HOUVER ALGUMA ASSINATURA COM MAIS DE 100 ANOS DE VIGÊNCIA*/
DELETE FROM PROJ_ASSINATURA
WHERE DATA_VIGENCIA IN (SELECT DATA_VIGENCIA 
						FROM PROJ_ASSINATURA 
						WHERE YEAR(DATA_VIGENCIA) < YEAR(GETDATE())-100) 



/*EXECICIO 8: OBJETIVO: SE UMA ASSINATURA (RECEBIDA PELO ID) ESTIVER VENCIDA, OU JA, 
NÃO ESTIVER PAGAS E ESTIVER ATRASADA, E A FORMA DE PAGAMENTO FOR 'C' (CRÉDITO) A FUNÇÃO RETORNARÁ 
O VALOR (PRECO DA REVISTA) + JUROS A SER PAGO, 
SE NÃO RETORNARÁ ZERO*/

CREATE FUNCTION FUNC_PROJ_EXERCICIO_8 (@ID_ASS NUMERIC(18),@VALOR_A_PAGAR NUMERIC(18,2))
RETURNS NUMERIC(18,2)
BEGIN
	
	IF EXISTS(SELECT *
				FROM PROJ_ASSINATURA A INNER JOIN PROJ_REVISTA R
					ON A.REVISTAID = R.REVISTAID
					INNER JOIN PROJ_PAGAMENTO P
					ON A.FORMA_PAGAMENTOID = P.PAGAMENTOID
					WHERE A.ASSINATURAID = @ID_ASS
					AND A.SIT_PAGAMENTO = 'N'
					AND A.SIT_PAGAMENTO = 'C'
					AND A.DATA_VENCIMENTO > GETDATE())
		BEGIN
			SELECT @VALOR_A_PAGAR = R.PRECO+(R.PRECO*p.JUROS_DIA)
				FROM PROJ_ASSINATURA A INNER JOIN PROJ_REVISTA R
					ON A.REVISTAID = R.REVISTAID
					INNER JOIN PROJ_PAGAMENTO P
					ON A.FORMA_PAGAMENTOID = P.PAGAMENTOID
					WHERE A.ASSINATURAID = @ID_ASS
					AND A.SIT_PAGAMENTO = 'N'
					AND A.SIT_PAGAMENTO = 'C'
					AND A.DATA_VENCIMENTO > GETDATE()
		END
	ELSE
		BEGIN
			SET @VALOR_A_PAGAR =
		END

	RETURN @VALOR_A_PAGAR
END
SELECT DBO.FUNC_PROJ_EXERCICIO_8(1,NULL) AS [VALOR TOTAL COM JUROS] FROM PROJ_ASSINATURA
WHERE ASSINATURAID = 1